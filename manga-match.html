<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>æ¼«ç•«ç¿»ç‰Œé…å°</title>
  <style>
    /* --- åŸºç¤æ¨£å¼ --- */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", "Helvetica Neue", sans-serif;
      background-color: #3D2B1F; /* æ·±æ£•è‰²ï¼Œç¬¦åˆå¾©å¤æ›¸åº—æ°›åœ */
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: #F5F5DC; /* ç±³è‰²æ–‡å­— */
    }

    /* --- éŠæˆ²ä¸»å®¹å™¨ --- */
    #game-container {
      width: 100%;
      max-width: 450px;
      padding: 20px;
      box-sizing: border-box;
      text-align: center;
    }

    h1 {
      font-size: 2.2em;
      margin-top: 0;
      margin-bottom: 10px;
      color: #FFD700; /* é‡‘è‰²æ¨™é¡Œï¼Œå¢åŠ æ‡·èˆŠæ„Ÿ */
      text-shadow: 2px 2px 3px #000;
    }

    #level-info {
      font-size: 1.2em;
      margin-bottom: 20px;
      min-height: 25px;
    }
    
    /* --- å¡ç‰Œå€åŸŸ --- */
    #game-board {
      display: grid;
      gap: 10px; /* æ¸›å°é–“è·ï¼Œæ›´åƒæ›¸æ¶ */
      justify-content: center;
      perspective: 1000px; /* å¢åŠ 3Dç¿»è½‰æ•ˆæœçš„é€è¦– */
    }

    /* --- å¡ç‰Œæ¨£å¼ --- */
    .card {
      width: 90px;
      height: 120px;
      cursor: pointer;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s;
    }
    .card.flipped {
      transform: rotateY(180deg);
      cursor: default;
    }
    .card.matched {
      transform: rotateY(180deg);
      opacity: 0.5; /* åŒ¹é…å¾Œæ·¡å‡ºï¼Œä½†ä¸æ¶ˆå¤± */
      cursor: default;
    }

    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden; /* éš±è—ç¿»è½‰å¾Œçš„èƒŒé¢ */
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      background-size: cover;
      background-position: center;
    }

    .card-back {
      background-color: #6F4E37; /* æ›¸æœ¬å°çš®çš„æ£•è‰² */
      border: 4px solid #F5F5DC;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2em;
      color: #F5F5DC;
    }

    .card-front {
      background-color: #fff;
      transform: rotateY(180deg); /* é å…ˆç¿»è½‰180åº¦ */
    }

    /* --- æŒ‰éˆ•æ¨£å¼ --- */
    #feedback-area {
        margin-top: 20px;
        min-height: 50px;
    }
    .game-btn {
      display: none;
      padding: 12px 30px;
      font-size: 1.3em;
      font-weight: bold;
      background-color: #AF4425; /* æ²¿ç”¨ä¸»éŠæˆ²é¢¨æ ¼çš„ç£šç´…è‰² */
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .game-btn:active {
        transform: scale(0.96);
    }
  </style>
</head>
<body>
  
  <div id="game-container">
    <h1>ç§Ÿæ›¸åº—æŒ‘æˆ°</h1>
    <div id="level-info"></div>
    <div id="game-board"></div>
    <div id="feedback-area">
        <button id="next-level-btn" class="game-btn">ä¸‹ä¸€é—œ</button>
    </div>
  </div>

  <script>
    // --- éŠæˆ²è¨­å®š ---
    const TOTAL_LEVELS = 3; // ç¸½å…±ç©3é—œ
    // æ¼«ç•«åœ–ç‰‡åº« (è«‹å°‡ 'assets/manga/mangaX.jpg' æ›¿æ›æˆæ‚¨çš„åœ–ç‰‡è·¯å¾‘)
    // å»ºè­°åœ–ç‰‡å°ºå¯¸ç‚ºæ­£æ–¹å½¢æˆ–çµ±ä¸€çš„ç›´å¼çŸ©å½¢
    const MANGA_IMAGES = [
      "assets/manga/manga1.jpg", "assets/manga/manga2.jpg", "assets/manga/manga3.jpg", 
      "assets/manga/manga4.jpg", "assets/manga/manga5.jpg", "assets/manga/manga6.jpg",
      "assets/manga/manga7.jpg", "assets/manga/manga8.jpg"
    ];

    // --- å…ƒç´ ç²å– ---
    const gameBoard = document.getElementById('game-board');
    const levelInfo = document.getElementById('level-info');
    const nextLevelBtn = document.getElementById('next-level-btn');
    const feedbackArea = document.getElementById('feedback-area');

    // --- éŠæˆ²ç‹€æ…‹è®Šæ•¸ ---
    let currentLevel = 1;
    let imagesForLevel = [];
    let cards = [];
    let flippedCards = [];
    let matchedPairs = 0;
    let lockBoard = false; // ç”¨æ–¼é˜²æ­¢åœ¨é…å°æª¢æŸ¥æ™‚é‡è¤‡é»æ“Š

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // æ ¹æ“šé—œå¡æ±ºå®šéœ€è¦å¹¾çµ„åœ–ç‰‡
    function getImagesForLevel(level) {
      const pairCount = level + 1; // ç¬¬1é—œ2çµ„ï¼Œç¬¬2é—œ3çµ„ï¼Œç¬¬3é—œ4çµ„
      // å¾åœ–ç‰‡åº«ä¸­éš¨æ©Ÿé¸å–æ‰€éœ€æ•¸é‡çš„åœ–ç‰‡
      return shuffle([...MANGA_IMAGES]).slice(0, pairCount);
    }

    function createCards(imgs) {
      const cardImages = shuffle([...imgs, ...imgs]);
      return cardImages.map((imgSrc, index) => ({
        id: index,
        image: imgSrc,
        isFlipped: false,
        isMatched: false,
      }));
    }

    function renderBoard() {
      gameBoard.innerHTML = '';
      const cardCount = cards.length;
      // è‡ªå‹•è¨ˆç®—è¡Œåˆ—ï¼Œè®“æ’ç‰ˆæ›´ç¾è§€
      const cols = cardCount === 4 ? 2 : (cardCount === 8 ? 4 : 3);
      gameBoard.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

      cards.forEach(cardData => {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card';
        if (cardData.isFlipped) cardDiv.classList.add('flipped');
        if (cardData.isMatched) cardDiv.classList.add('matched');
        
        cardDiv.innerHTML = `
          <div class="card-face card-back"><span>ğŸ“–</span></div>
          <div class="card-face card-front" style="background-image: url('${cardData.image}')"></div>
        `;

        if (!cardData.isMatched) {
            cardDiv.addEventListener('click', () => flipCard(cardData));
        }
        
        gameBoard.appendChild(cardDiv);
      });
    }

    function flipCard(clickedCard) {
      if (lockBoard || clickedCard.isFlipped || flippedCards.length >= 2) return;
      
      clickedCard.isFlipped = true;
      flippedCards.push(clickedCard);
      renderBoard();

      if (flippedCards.length === 2) {
        lockBoard = true;
        setTimeout(checkForMatch, 1000);
      }
    }

    function checkForMatch() {
      const [cardA, cardB] = flippedCards;
      if (cardA.image === cardB.image) {
        cardA.isMatched = true;
        cardB.isMatched = true;
        matchedPairs++;
      } else {
        cardA.isFlipped = false;
        cardB.isFlipped = false;
      }
      
      flippedCards = [];
      lockBoard = false;
      renderBoard();

      // æª¢æŸ¥é—œå¡æ˜¯å¦å®Œæˆ
      if (matchedPairs === imagesForLevel.length) {
        if (currentLevel < TOTAL_LEVELS) {
            levelInfo.textContent = 'å¤ªå²å®³äº†ï¼ä½ éƒ½è¨˜å¾—ï¼';
            nextLevelBtn.style.display = 'inline-block';
        } else {
            // æ‰€æœ‰é—œå¡å®Œæˆ
            levelInfo.textContent = 'æ­å–œï¼ä½ æ‰¾å›äº†æ‰€æœ‰æ¼«ç•«çš„å›æ†¶ï¼';
            // ã€â˜…â˜…â˜… æ•´åˆé—œéµ â˜…â˜…â˜…ã€‘
            // å‘çˆ¶è¦–çª—ç™¼é€å®Œæˆè¨Šæ¯
            setTimeout(() => {
                window.parent.postMessage('manga-match-complete', '*');
            }, 1500); // å»¶é²1.5ç§’ï¼Œè®“ç©å®¶çœ‹åˆ°å‹åˆ©è¨Šæ¯
        }
      }
    }

    function startLevel(level) {
      currentLevel = level;
      imagesForLevel = getImagesForLevel(level);
      cards = createCards(imagesForLevel);
      flippedCards = [];
      matchedPairs = 0;
      lockBoard = false;

      levelInfo.textContent = `ç¬¬ ${level} å±¤æ›¸æ¶ - æ‰¾å‡º ${imagesForLevel.length} å°æ¼«ç•«`;
      nextLevelBtn.style.display = 'none';
      renderBoard();
    }

    nextLevelBtn.addEventListener('click', () => {
        startLevel(currentLevel + 1);
    });

    // --- éŠæˆ²å•Ÿå‹• ---
    startLevel(1);

  </script>
</body>
</html>